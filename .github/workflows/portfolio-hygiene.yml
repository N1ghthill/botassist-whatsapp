name: Portfolio Hygiene Issue

on:
  schedule:
    # Monthly: day 1 at 12:00 UTC
    - cron: "0 12 1 * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: portfolio-hygiene-issue
  cancel-in-progress: false

jobs:
  open-monthly-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Create monthly hygiene issue (deduplicated)
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const year = now.getUTCFullYear();
            const month = String(now.getUTCMonth() + 1).padStart(2, "0");
            const ym = `${year}-${month}`;
            const title = `Ritual mensal: higiene do portfolio (${ym})`;

            const q = `repo:${context.repo.owner}/${context.repo.repo} is:issue in:title \"${title}\"`;
            const existing = await github.rest.search.issuesAndPullRequests({
              q,
              per_page: 10,
            });

            if (existing.data.total_count > 0) {
              core.notice(`Issue already exists for ${ym}. Skipping.`);
              return;
            }

            const desiredLabels = [
              "type: chore",
              "priority: medium",
              "status: ready",
              "area:infra",
            ];

            const repoLabels = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            const labelSet = new Set(repoLabels.map((l) => l.name));
            const labels = desiredLabels.filter((l) => labelSet.has(l));

            const body = [
              "## Objetivo",
              "Executar a higiene mensal do portfolio e manter priorizacao realista.",
              "",
              "## Checklist",
              "- [ ] Revisar milestones ativas (Q1/Q2) e ajustar itens obsoletos",
              "- [ ] Validar prioridades (`priority: high/medium/low`)",
              "- [ ] Fechar ou atualizar itens `In Progress` sem progresso",
              "- [ ] Marcar bloqueios com `status: blocked`",
              "- [ ] Garantir no maximo 2 itens em `In Progress` por vez",
              "- [ ] Criar 3-5 itens estrategicos para o proximo ciclo",
              "",
              "## Resultado esperado",
              "Backlog limpo, foco semanal claro e roadmap atualizado.",
            ].join("\n");

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels,
            });

            core.notice(`Created: ${issue.data.html_url}`);
